<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Morbilidad BI - Animaciones Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --dark: #0f172a;
            --bg: #f8fafc;
        }
        
        body { background-color: var(--bg); font-family: 'Inter', system-ui, sans-serif; padding: 30px; }
        
        .card { 
            border: none; 
            border-radius: 24px; 
            background: white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .kpi-title { color: #64748b; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-value { font-size: 2.5rem; font-weight: 800; color: var(--dark); }

        .filter-pill { 
            background: white; 
            border-radius: 50px; 
            padding: 10px 30px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: inline-flex;
            gap: 20px;
            border: 1px solid #e2e8f0;
        }

        select { border: none !important; font-weight: 600; color: var(--primary); outline: none; background: transparent; cursor: pointer; }
        
        .badge-cie { background: #eef2ff; color: #4338ca; border-radius: 8px; padding: 5px 12px; font-weight: 700; }
        
        /* Animación para la tabla */
        tbody tr { transition: all 0.3s ease; }
        tbody tr:hover { background-color: #f1f5f9; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-0">Análisis de Morbilidad</h2>
            <p class="text-secondary">Dashboard Interactivo con Animaciones Dinámicas</p>
        </div>
        <input type="file" id="fileInput" class="form-control w-auto rounded-pill shadow-sm border-primary">
    </div>

    <div id="app" style="display: none;">
        <div class="text-center mb-5">
            <div class="filter-pill">
                <select id="fServicio"></select>
                <select id="fMes"></select>
                <select id="fAnio"></select>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4"><div class="card p-4 text-center border-bottom border-4 border-primary"><div class="kpi-title">Total Casos</div><div id="val-total" class="kpi-value">0</div></div></div>
            <div class="col-md-4"><div class="card p-4 text-center border-bottom border-4 border-info"><div class="kpi-title">Femenino</div><div id="val-fem" class="kpi-value" style="color:#ec4899">0</div></div></div>
            <div class="col-md-4"><div class="card p-4 text-center border-bottom border-4 border-primary-subtle"><div class="kpi-title">Masculino</div><div id="val-masc" class="kpi-value" style="color:#3b82f6">0</div></div></div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card p-4 h-100">
                    <h6 class="fw-bold mb-4">Atenciones por Servicio</h6>
                    <canvas id="chartServicios"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-4 h-100">
                    <h6 class="fw-bold mb-4">Género</h6>
                    <canvas id="chartGenero"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-4 mb-4">
            <h6 class="fw-bold mb-4 text-center">Top 10 Diagnósticos (CIE10) - Ranking Visual</h6>
            <canvas id="chartTopCIE" height="80"></canvas>
        </div>

        <div class="card p-4 shadow-sm">
            <h6 class="fw-bold mb-4">Listado de Diagnósticos Prevalentes</h6>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="small text-secondary text-uppercase">
                        <tr>
                            <th>CIE10</th>
                            <th>Descripción del Diagnóstico</th>
                            <th class="text-end">Cantidad</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-cie"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let charts = {};

    // CONFIGURACIÓN DE ANIMACIÓN GLOBAL
    const animacionPro = {
        duration: 2500, // 2.5 segundos para que se note el movimiento
        easing: 'easeOutElastic', // Efecto de rebote moderno
        delay: (context) => context.dataIndex * 100 // Los datos entran uno por uno
    };

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function() {
            const filas = reader.result.split('\n').filter(l => l.trim() !== '').map(l => l.split(';'));
            rawData = filas.slice(1).map(c => ({
                servicio: c[0]?.trim(),
                mes: c[2]?.trim(),
                cie10: c[3]?.trim(),
                desc: c[4]?.trim(),
                genero: c[7]?.trim(),
                anio: c[1]?.split('/')[2]
            }));
            poblarFiltros();
            document.getElementById('app').style.display = 'block';
            filtrar();
        };
        reader.readAsText(e.target.files[0]);
    });

    function poblarFiltros() {
        const set = (id, k) => {
            const items = ['Todos', ...new Set(rawData.map(d => d[k]))].sort();
            const el = document.getElementById(id);
            el.innerHTML = items.map(i => `<option value="${i}">${i}</option>`).join('');
            el.value = 'Todos';
        };
        set('fServicio', 'servicio'); set('fMes', 'mes'); set('fAnio', 'anio');
    }

    document.querySelectorAll('select').forEach(s => s.addEventListener('change', filtrar));

    function filtrar() {
        const sS = document.getElementById('fServicio').value;
        const sM = document.getElementById('fMes').value;
        const sA = document.getElementById('fAnio').value;

        const filtered = rawData.filter(d => 
            (sS === 'Todos' || d.servicio === sS) &&
            (sM === 'Todos' || d.mes === sM) &&
            (sA === 'Todos' || d.anio === sA)
        );
        updateUI(filtered);
    }

    function updateUI(data) {
        let f = 0, m = 0;
        const srvs = {}, cies = {};
        
        data.forEach(d => {
            if(d.genero === 'F') f++; else m++;
            srvs[d.servicio] = (srvs[d.servicio] || 0) + 1;
            if(d.cie10) cies[d.cie10] = { c: (cies[d.cie10]?.c || 0) + 1, d: d.desc };
        });

        document.getElementById('val-total').innerText = data.length.toLocaleString();
        document.getElementById('val-fem').innerText = f.toLocaleString();
        document.getElementById('val-masc').innerText = m.toLocaleString();

        const top = Object.entries(cies).sort((a,b)=>b[1].c - a[1].c).slice(0,10);
        
        document.getElementById('tabla-cie').innerHTML = top.map(x => `
            <tr>
                <td><span class="badge-cie">${x[0]}</span></td>
                <td class="text-secondary small text-uppercase">${x[1].d}</td>
                <td class="text-end fw-bold text-dark">${x[1].c.toLocaleString()}</td>
            </tr>`).join('');

        renderCharts(srvs, f, m, top);
    }

    function renderCharts(srvs, f, m, topCIE) {
        // 1. Servicios
        if(charts.srv) charts.srv.destroy();
        charts.srv = new Chart(document.getElementById('chartServicios'), {
            type: 'bar',
            data: {
                labels: Object.keys(srvs),
                datasets: [{ 
                    data: Object.values(srvs), backgroundColor: '#6366f1', borderRadius: 15, barThickness: 18
                }]
            },
            options: { indexAxis: 'y', animation: animacionPro, plugins: { legend: false } }
        });

        // 2. Género
        if(charts.gen) charts.gen.destroy();
        charts.gen = new Chart(document.getElementById('chartGenero'), {
            type: 'doughnut',
            data: {
                labels: ['F', 'M'],
                datasets: [{ 
                    data: [f, m], backgroundColor: ['#ec4899', '#3b82f6'], borderWidth: 8, borderColor: '#ffffff', cutout: '75%' 
                }]
            },
            options: { animation: animacionPro, plugins: { legend: { position: 'bottom' } } }
        });

        // 3. Ranking CIE10
        if(charts.cie) charts.cie.destroy();
        charts.cie = new Chart(document.getElementById('chartTopCIE'), {
            type: 'bar',
            data: {
                labels: topCIE.map(x => x[0]),
                datasets: [{ 
                    label: 'Casos',
                    data: topCIE.map(x => x[1].c), 
                    backgroundColor: '#1e293b', 
                    borderRadius: 20,
                    barThickness: 40
                }]
            },
            options: { 
                animation: animacionPro,
                plugins: { legend: false },
                scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
            }
        });
    }
</script>
</body>
</html>

