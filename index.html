<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tablero de Morbilidad Dinámico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f9; padding: 20px; font-family: sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .kpi { font-size: 2.5rem; font-weight: bold; color: #1a2a6c; }
        .loading { text-align: center; padding: 50px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loader" class="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Conectando con los datos de Google Drive...</p>
    </div>

    <div id="app" style="display:none;">
        <div class="text-center mb-5">
            <h1 class="fw-bold" style="color: #1a2a6c;">Análisis de Morbilidad 2026</h1>
            <span class="badge bg-success">Datos Sincronizados</span>
        </div>

        <div class="row mb-4">
            <div class="col-md-4"><div class="card p-3 text-center"><h6>CASOS TOTALES</h6><div id="total" class="kpi">0</div></div></div>
            <div class="col-md-4"><div class="card p-3 text-center"><h6>MUJERES</h6><div id="fem" class="kpi" style="color: #d63384;">0</div></div></div>
            <div class="col-md-4"><div class="card p-3 text-center"><h6>HOMBRES</h6><div id="masc" class="kpi" style="color: #0d6efd;">0</div></div></div>
        </div>

        <div class="row">
            <div class="col-md-8"><div class="card p-4"><h5>Top Servicios</h5><canvas id="barras"></canvas></div></div>
            <div class="col-md-4"><div class="card p-4"><h5>Género</h5><canvas id="dona"></canvas></div></div>
        </div>
    </div>

    <div id="error-box" class="alert alert-danger mt-5" style="display:none;">
        <h4>⚠️ No se pudo cargar el tablero</h4>
        <p id="error-txt"></p>
        <hr>
        <strong>¿Cómo lo soluciono?</strong><br>
        1. Sube este archivo HTML a <strong>Netlify Drop</strong> o <strong>GitHub Pages</strong>. Google bloquea la carga si abres el archivo directamente desde tu carpeta local.
    </div>
</div>

<script>
const ID_ARCHIVO = '1cMG2OFQmarqSzu5F2MP6SwRe5brPgLNB';
const URL_DRIVE = `https://docs.google.com/uc?export=download&id=${ID_ARCHIVO}`;

async function iniciar() {
    try {
        const res = await fetch(URL_DRIVE);
        if (!res.ok) throw new Error("Google Drive denegó el acceso (CORS o Permisos).");
        
        const texto = await res.text();
        const lineas = texto.split('\n').filter(l => l.trim() !== '').map(l => l.split(';'));
        const datos = lineas.slice(1);

        let f = 0, m = 0;
        let servicios = {};

        datos.forEach(col => {
            if (col.length < 8) return;
            // Género en columna 7, Servicio en columna 0
            if (col[7].trim() === 'F') f++;
            if (col[7].trim() === 'M') m++;
            servicios[col[0]] = (servicios[col[0]] || 0) + 1;
        });

        document.getElementById('total').innerText = datos.length;
        document.getElementById('fem').innerText = f;
        document.getElementById('masc').innerText = m;

        // Gráfico de Barras
        new Chart(document.getElementById('barras'), {
            type: 'bar',
            data: {
                labels: Object.keys(servicios),
                datasets: [{ label: 'Consultas', data: Object.values(servicios), backgroundColor: '#1a2a6c' }]
            },
            options: { indexAxis: 'y' }
        });

        // Gráfico Dona
        new Chart(document.getElementById('dona'), {
            type: 'doughnut',
            data: {
                labels: ['Mujeres', 'Hombres'],
                datasets: [{ data: [f, m], backgroundColor: ['#d63384', '#0d6efd'] }]
            }
        });

        document.getElementById('loader').style.display = 'none';
        document.getElementById('app').style.display = 'block';

    } catch (e) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('error-box').style.display = 'block';
        document.getElementById('error-txt').innerText = e.message;
    }
}
iniciar();
</script>
</body>
</html>
