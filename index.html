<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tablero de Morbilidad Real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .kpi-box { text-align: center; padding: 20px; }
        .kpi-value { font-size: 2.5rem; font-weight: bold; color: #1a2a6c; }
        #error-msg { display: none; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-5">
        <h1 style="color: #1a2a6c;">Dashboard de Morbilidad Dinámico</h1>
        <span class="badge bg-success">Conexión: Google Drive</span>
    </div>

    <div id="error-msg" class="alert alert-danger shadow">
        <h4>⚠️ Error de Conexión</h4>
        <p>No se pudieron leer los datos. Esto sucede por 2 razones:</p>
        <ul>
            <li><b>Permisos:</b> Asegúrate de que el archivo en Drive esté como "Cualquier persona con el enlace".</li>
            <li><b>Seguridad del Navegador:</b> Google bloquea peticiones externas si abres el archivo directamente desde tu carpeta (file://). <b>Debes subirlo a un servidor (como GitHub o Netlify) para que funcione.</b></li>
        </ul>
    </div>

    <div class="row mb-4">
        <div class="col-md-4"><div class="card kpi-box"><div class="text-muted small">TOTAL CONSULTAS</div><div id="total" class="kpi-value">...</div></div></div>
        <div class="col-md-4"><div class="card kpi-box"><div class="text-muted small">FEMENINO</div><div id="fem" class="kpi-value" style="color: #d63384;">...</div></div></div>
        <div class="col-md-4"><div class="card kpi-box"><div class="text-muted small">MASCULINO</div><div id="masc" class="kpi-value" style="color: #0d6efd;">...</div></div></div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8"><div class="card p-4"><h5>Casos por Servicio</h5><canvas id="graficoBarras"></canvas></div></div>
        <div class="col-md-4"><div class="card p-4"><h5>Género</h5><canvas id="graficoDona"></canvas></div></div>
    </div>
</div>

<script>
// ID de tu archivo
const idArchivo = '1cMG2OFQmarqSzu5F2MP6SwRe5brPgLNB';
const urlDescarga = `https://docs.google.com/uc?export=download&id=${idArchivo}`;

async function cargarTablero() {
    try {
        const res = await fetch(urlDescarga);
        if (!res.ok) throw new Error("Acceso bloqueado");
        
        const csv = await res.text();
        const filas = csv.split('\n').map(f => f.split(';')); // Separador punto y coma
        const datos = filas.slice(1);

        let fCount = 0, mCount = 0;
        const servicios = {};

        datos.forEach(col => {
            if(col.length < 5) return;
            // Género está en la columna 7 (F/M)
            if(col[7] === 'F') fCount++;
            if(col[7] === 'M') mCount++;
            // Servicio está en la columna 0
            const s = col[0];
            servicios[s] = (servicios[s] || 0) + 1;
        });

        // Actualizar KPIs
        document.getElementById('total').innerText = datos.length;
        document.getElementById('fem').innerText = fCount;
        document.getElementById('masc').innerText = mCount;

        // Renderizar Gráficos
        new Chart(document.getElementById('graficoBarras'), {
            type: 'bar',
            data: { labels: Object.keys(servicios), datasets: [{ label: 'Casos', data: Object.values(servicios), backgroundColor: '#1a2a6c' }] },
            options: { indexAxis: 'y' }
        });

        new Chart(document.getElementById('graficoDona'), {
            type: 'doughnut',
            data: { labels: ['Mujeres', 'Hombres'], datasets: [{ data: [fCount, mCount], backgroundColor: ['#d63384', '#0d6efd'] }] }
        });

    } catch (err) {
        console.error(err);
        document.getElementById('error-msg').style.display = 'block';
    }
}
cargarTablero();
</script>
</body>
</html>